# Automatic Deploy of Content Built from CMS Export

**Author(s):** Jhonny Gonzalez  
**Last Updated:** December 10, 2020  
**Status:** **Draft** | In Review | Approved  
**Approvers:**

- [ ] Theo Bentum
- [ ] Dan Shank
- [ ] Neil Hastings
- [ ] Dror Matalon
- [ ] Michael Fleet

## Overview

### Objective

This document explores an approach to automatically deploying (auto-deploying) a partial content build using CMS (content management system) export data.
The approach also considers a feasible frequency for the build and deploy that does not overload the build system.

This document **does not** discuss the design of the full build and deploy using CMS export data.

The intended audience are front-end (FE) and DevOps engineers on the Veteran-facing Services Platform (VSP) and the CMS teams.

### Background

The VA.gov website is currently built from the `vets-website` repo. The build outputs static HTML content, React applications, and styling.

The static content is built using data pulled from the Drupal-based CMS and the [`vagov-content` repo](https://github.com/department-of-veterans-affairs/vagov-content/).

Currently, the data from the Drupal server is fetched with a GraphQL query. However, the GraphQL-based build has limitations in scalability, so an alternative implementation of the content build is being developed to replace it.

This implementation, the CMS export build, involves the [transformation](https://github.com/department-of-veterans-affairs/va.gov-team/tree/master/products/cms-integration) of CMS export data generated by [Tome Sync](https://tome.fyi/docs/sub-modules/) into a content model that matches that of the GraphQL data.

#### Build script

To generate the HTML files from Drupal nodes, we run a [Metalsmith](https://github.com/segmentio/metalsmith) pipeline that follows these steps:

1. Fetch a tar file with all Drupal nodes.
2. Untar the files to get the individual nodes.
3. Use transformers to transform the data in the nodes to a format that is easy for the liquid templates to ingest.
4. Convert the page nodes to HTML files using the [Liquid templating engine](https://github.com/leizongmin/tinyliquid#readme). 

The highlights of the script that is included in the content build can be found [here](https://github.com/department-of-veterans-affairs/va.gov-team/blob/master/platform/engineering/design-docs/2020-04-09-separate-content-build.md#build-script).

#### Drupal build script

We currently have the option of creating the build using the GraphQL (GraphQL build) or using transformers (CMS build). This is done by passing the `--use-cms-export` into the Jenkins file

##### Process to obtain the Drupal content from GraphQL

1. Metalsmith calls the [`getDrupalContent`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L258) function from [`/drupal/metalsmith-drupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js)
2. The [`getDrupalContent`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L258) function calls [`loadDrupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js) while passing `buildOptions` as the argument
3. The [`loadDrupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L214) function then calls [`getContentViaGraphQL`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L143)

##### Process to obtain the Drupal content from CMS

1. Metalsmith calls the [`getDrupalContent`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L258) function from [`/drupal/metalsmith-drupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js)
2. The [`getDrupalContent`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L258) function calls [`loadDrupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L214) while passing `buildOptions` as the argument
3. The [`loadDrupal`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L214) function verifies that the `--use-cms-export` flag is set to `true`, if so, it calls [`getContentFromExport`](https://github.com/department-of-veterans-affairs/vets-website/blob/7b4c87257cfc9b5e684c4ba7ddca283efbc4329d/src/site/stages/build/drupal/metalsmith-drupal.js#L199)

#### Deployment

There are two kinds of deployments:

|                     | [Partial Deploy](https://department-of-veterans-affairs.github.io/veteran-facing-services-tools/getting-started/workflow/deploy/#partial-deploy--static-page-changes-only)                                                                                                                                                                                                 | [Full Deploy](https://department-of-veterans-affairs.github.io/veteran-facing-services-tools/getting-started/workflow/deploy/#full-deploy-of-vagov-client-app) |
| ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Output              | Static pages (.html) only                                                                                                                                                                                                                                                                                                                                                  | Frontend applications (.js, .css) and static pages (.html)                                                                                                     |
| Assets              | Uses the latest `vets-website` release and static asset                                                                                                                                                                                                                                                                                                                    | Creates a new release and deploys it                                                                                                                           |
| Accessibility tests | N/A                                                                                                                                                                                                                                                                                                                                                                        | Runs tests                                                                                                                                                     |
| Links checker       | Runs checks                                                                                                                                                                                                                                                                                                                                                                                                                                          | Runs checks                                                                                                                                                    |

Both deployments will be essential to achieve the goal:

1. Webpack auto-deploy once per day (This already exists)
   - [Content build Jenkinsfile](https://github.com/department-of-veterans-affairs/vets-website/blob/master/Jenkinsfile#L63)
2. Content-only auto-deploy every 5 minutes (Needs to be implemented, interval time may vary)
   - [Content-only build Jenkinsfile](https://github.com/department-of-veterans-affairs/vets-website/blob/2b8c478ebe48882ca098a7c8f4cf684c69fb3114/Jenkinsfile.content#L72)

Both Jenkins files are called from [`common.groovy`](https://github.com/department-of-veterans-affairs/vets-website/blob/master/jenkins/common.groovy)

#### Pain points

- Engineers encounter confusing build errors that are due to the mismatch in outdated locally cached content and updated Liquid templates
- Failure using the latest CMS content
- CMS triggers content build manually
- Content writers want to quickly draft, publish, and deploy content. However, `vets-website` is only deployed to production once per day. To allow content writers to move faster, there is a partial deploy, which only includes static page changes (vagov-content and Drupal).
- No accessibility checking

### High Level Design

Metalsmith will pass the CMS flag so the CMS content build will be called.

There are three things that will be to happen:

1. A full deploy
2. A recurrent partial deploy (every 5 mins ideally)
3. A script to verify the CMS content

## Specifics

### Detailed Design

#### A full deploy

To deploy the CMS content build inside the current auto-deploy for `vets-website` the `--use-cms-export` flag will need to be passed to the `build` function inside [`common.groovy`](https://github.com/department-of-veterans-affairs/vets-website/blob/master/jenkins/common.groovy)

#### A recurrent partial deploy (every 5 mins ideally)

In addition to the full deploy, a partial deploy needs to be fired up to create a content-only build and update the AWS bucket with the newest content.

Currently, the CMS team is doing this process manually. They have been deploying content-only as needed.

CMS team has recommended an auto-deploy with 5 mins intervals while they provide support.

Create a Jenkins/CircleCI job to run a cron job that will trigger a partial deploy, initially, every hour from 8am-8pm EST. Depending on the success rate of the build, the intervals time will be reduced.

#### Only run the script on content change

We compare the tar file to the previous tar file and only run the build when there are differences between the tar files. This ensures that we only run the build when there’s been a change to the content.

#### When to deploy the content-only build

There needs to be a script that will:

- Download the CMS content (`.tar`) file and will compare it with the previous one
- Ensure that the `.tar` file is zipped by using `File [namefile]`
- Test the files using `md5 Checksum`
- Deploy only if the contents are different
- Time to do the partial build (optional)

### Code Location

All the CMS export content (transformers) is located in `src/site/stages/build/process-cms-exports`

### Testing Plan

- There will be an automatic test for comparing build outputs in Jenkins
- There might be a secondary or follow-up test if the automated test is inadequate for catching regressions

### Logging

Currently, invalid content is logged in the build log during staging deploys. And failed builds trigger generic Slack notifications.

### Debugging

#### Content

##### Build

When the `process-cms-exports` system is live, there will be automated tests to validate input from the CMS and output from the content transformers.

##### Deploy

To determine whether a page exists in the drupal content, we can go to [`staging.va.gov/drupal/debug/`](staging.va.gov/drupal/debug/). This page is not available in production, however.

### Caveats

To be determined.

### Security Concerns

There are no new security concerns with a full nor partial build.

### Privacy Concerns

There are no new privacy concerns with a full nor partial build.

### Open Questions and Risks

#### Questions

- CMS separation and the apps needs to happen first?
- What is the period to run the partial build intervals, from 8am-8pm EST?
- Should we consider incremental deploys instead?

#### Risks

- Introduction to new CMS content and no transformer schema is available can:
  - Break the build
  - Create new discrepancies, making the script that verifies the `diff` fail
  - the interval of running a partial build is smaller than the time the partial build takes

### Work Estimates

_Split the work into milestones that can be delivered, put them in the order that you think they should be done, and estimate roughly how much time you expect it each milestone to take. Ideally each milestone will take one week or less._

### Alternatives

_This section contains alternative solutions to the stated objective, as well as explanations for why they weren't used. In the planning stage, this section is useful for understanding the value added by the proposed solution and why particular solutions were discarded. Once the system has been implemented, this section will inform readers of alternative solutions so they can find the best system to address their needs._

### Future Work

_Features you'd like to (or will need to) add but aren't required for the current release. This is a great place to speculate on potential features and performance improvements._

### Revision History

| Date         | Revisions Made | Author          |
| ------------ | -------------- | --------------- |
| Dec 10, 2020 | Initial draft  | Jhonny Gonzalez |
